---
title: "ユースケース：AIコードレビューワークフローの設計"
description: "Claude Code Workflow Studioで効果的なコードレビューワークフローを設計する方法を解説します。品質向上とレビュー効率化を実現しましょう。"
pubDate: 2024-02-01
author: "Code Quality Team"
---

## はじめに

コードレビューは品質保証の重要なプロセスですが、時間がかかり見落としも発生しやすいものです。Claude Code Workflow Studioで設計したAIレビューワークフローを使えば、一貫性のある高品質なレビューを効率的に実施できます。

## 課題

開発チームが直面する典型的なレビュー課題：

- **レビューの遅延**: レビュアーの時間確保が難しく、マージが遅れる
- **品質のばらつき**: レビュアーによってチェック項目や厳しさが異なる
- **チェック漏れ**: セキュリティやパフォーマンスの問題を見落とす
- **知識の偏り**: 特定領域に詳しいレビュアーがいない

## ソリューション：ビジュアルレビューワークフロー

Claude Code Workflow Studioでレビューフローを設計すれば：

- **一貫性**: 毎回同じ観点でレビュー
- **迅速性**: AIが即座にフィードバック
- **包括性**: セキュリティ、パフォーマンス、品質を網羅
- **柔軟性**: レビューレベルや対象を選択可能

## ワークフロー設計例

### 全体構成

```
[Start]
   ↓
[Code Scanner] ← 変更ファイルを取得
   ↓
[Choose Review Level] ← レビューの厳しさを選択
   ↓
[Security Reviewer] ← セキュリティチェック
   ↓
[Performance Reviewer] ← パフォーマンスチェック
   ↓
[Quality Reviewer] ← コード品質チェック
   ↓
[Summary Generator] ← レビュー結果まとめ
   ↓
[End]
```

### ステップ1: Code Scanner（コードスキャン）

#### ノード設定

**ノードタイプ**: Sub-Agent

**設定**：
- **Name**: `Code Scanner`
- **Prompt**:
```
直近のコミットで変更されたファイルを特定してください：

1. git diff を使用して変更ファイルを取得
2. 各ファイルの変更内容を読み込み
3. 変更の種類を分類：
   - 新規ファイル
   - 既存ファイルの修正
   - 削除されたファイル
4. 変更されたコード行数を集計

レビュー対象の範囲を明確にしてください。
```
- **Tools**: Bash, Read, Grep
- **Model**: Haiku（高速スキャン）

#### 設計のポイント

- **Haiku使用**: 単純なファイル取得は高速なHaikuで
- **Bash権限**: git コマンド実行のため必要
- **範囲の明確化**: 次のステップで何をレビューするか明示

### ステップ2: Choose Review Level（レビューレベル選択）

#### ノード設定

**ノードタイプ**: AskUserQuestion

**設定**：
- **Question**: `どのレベルでレビューしますか？`
- **Header**: `Review Level`
- **Options**:
  - **Option 1**:
    - Label: `クイック`
    - Description: `明らかな問題のみチェック（5分以内）`
  - **Option 2**:
    - Label: `標準`
    - Description: `セキュリティ、パフォーマンス、品質を網羅（15分程度）`
  - **Option 3**:
    - Label: `徹底`
    - Description: `詳細な分析と改善提案（30分以上）`

#### 設計のポイント

- **時間の目安**: 各レベルの所要時間を明示
- **使い分け**: 緊急時はクイック、本番リリース前は徹底
- **段階的**: レベルに応じてプロンプトを調整

### ステップ3: Security Reviewer（セキュリティレビュー）

#### ノード設定

**ノードタイプ**: Sub-Agent

**設定**：
- **Name**: `Security Reviewer`
- **Prompt**:
```
セキュリティの観点からコードをレビューしてください：

## チェック項目

### 1. インジェクション攻撃
- SQLインジェクション
- コマンドインジェクション
- XSS（クロスサイトスクリプティング）

### 2. 認証・認可
- 適切な認証チェック
- 権限検証の実装
- セッション管理の安全性

### 3. 機密情報
- APIキーやパスワードのハードコーディング
- 個人情報の適切な取り扱い
- ログへの機密情報出力

### 4. 入力バリデーション
- ユーザー入力の検証
- ファイルアップロードの制限
- データ型のチェック

## 出力形式
各問題について：
- 重要度（Critical/High/Medium/Low）
- 問題箇所（ファイル名と行番号）
- 問題の説明
- 修正方法の提案
```
- **Tools**: Read, Grep
- **Model**: Opus（高度なセキュリティ分析）

#### 設計のポイント

- **Opus使用**: セキュリティは重要なのでOpusで慎重に分析
- **構造化出力**: 重要度と修正方法を明記
- **OWASP準拠**: 一般的な脆弱性パターンをカバー

### ステップ4: Performance Reviewer（パフォーマンスレビュー）

#### ノード設定

**ノードタイプ**: Sub-Agent

**設定**：
- **Name**: `Performance Reviewer`
- **Prompt**:
```
パフォーマンスの観点からコードをレビューしてください：

## チェック項目

### 1. アルゴリズムの効率
- 計算量（O記法で評価）
- 不要なループや再帰
- データ構造の適切性

### 2. データベースクエリ
- N+1問題
- インデックスの活用
- 不要なデータ取得

### 3. メモリ使用
- メモリリークの可能性
- 不要なオブジェクト保持
- 大量データの一括読み込み

### 4. 非同期処理
- ブロッキング処理
- 並列化の機会
- キャッシュの活用

## 出力形式
- 問題箇所
- 現在の計算量
- 改善後の予想計算量
- 具体的な改善コード例
```
- **Tools**: Read, Grep
- **Model**: Sonnet

#### 設計のポイント

- **定量的評価**: O記法で効率を明示
- **改善コード**: Before/Afterを具体的に提示
- **実践的**: 実装可能な改善案を提案

### ステップ5: Quality Reviewer（品質レビュー）

#### ノード設定

**ノードタイプ**: Sub-Agent

**設定**：
- **Name**: `Quality Reviewer`
- **Prompt**:
```
コード品質の観点からレビューしてください：

## チェック項目

### 1. 可読性
- 命名規則の一貫性
- 適切なコメント
- マジックナンバーの排除

### 2. 保守性
- 関数の長さ（20行以内推奨）
- 循環的複雑度
- 重複コードの検出

### 3. テスタビリティ
- 依存性注入の活用
- 純粋関数の使用
- テストしやすい構造

### 4. ベストプラクティス
- 言語/フレームワークの慣例
- デザインパターンの適切な適用
- エラーハンドリング

## 出力形式
- 優先度（Must/Should/Nice-to-have）
- 改善提案
- 参考資料（あれば）
```
- **Tools**: Read, Grep
- **Model**: Sonnet

#### 設計のポイント

- **優先度付け**: Must/Should/Nice-to-haveで分類
- **教育的**: なぜその改善が必要かを説明
- **実用的**: チーム内のコーディング規約に準拠

### ステップ6: Summary Generator（サマリー生成）

#### ノード設定

**ノードタイプ**: Sub-Agent

**設定**：
- **Name**: `Summary Generator`
- **Prompt**:
```
レビュー結果を統合してサマリーを作成してください：

## レビューサマリー

### 📊 全体評価
- スコア: X/100
- レビューレベル: {{review_level}}
- 変更ファイル数: X件
- 変更行数: X行

### 🔴 クリティカル（即修正必須）
- 問題1
- 問題2

### 🟡 重要（修正推奨）
- 問題1
- 問題2

### 🟢 軽微（余裕があれば対応）
- 提案1
- 提案2

### ✅ 良い点
- 良かった実装
- 改善された箇所

### 📝 次のアクション
1. クリティカルな問題の修正
2. 重要な問題への対応検討
3. テストカバレッジの確認

レビュー結果はreviews/ディレクトリに保存してください。
```
- **Tools**: Read, Write
- **Model**: Sonnet

#### 設計のポイント

- **視覚的**: 絵文字で優先度を表現
- **アクショナブル**: 次に何をすべきか明示
- **ポジティブ**: 良い点も指摘してモチベーション維持

## ノードの接続

すべてのレビューノードは順番に実行：

```
Code Scanner
   ↓
Choose Review Level
   ↓
Security Reviewer
   ↓
Performance Reviewer
   ↓
Quality Reviewer
   ↓
Summary Generator
```

レビューレベルによってプロンプトの詳細度を調整する場合は、Branchノードを追加して分岐させることも可能です。

## 保存とエクスポート

### 保存

1. ワークフロー名: `ai-code-review`
2. Save ボタンをクリック
3. `.vscode/workflows/ai-code-review.json` に保存

### エクスポート

生成されるファイル：
- `.claude/agents/Code_Scanner.md`
- `.claude/agents/Security_Reviewer.md`
- `.claude/agents/Performance_Reviewer.md`
- `.claude/agents/Quality_Reviewer.md`
- `.claude/agents/Summary_Generator.md`
- `.claude/commands/ai-code-review.md`

## 実行方法

### 通常実行

```
/ai-code-review
```

### Git Hookとの連携

`pre-push` フックに組み込めば、プッシュ前に自動レビュー：

```bash
#!/bin/bash
# .git/hooks/pre-push

echo "Running AI code review..."
claude-code /ai-code-review
```

## ベストプラクティス

### 1. レビューレベルの使い分け

- **クイック**: ホットフィックス、緊急対応
- **標準**: 通常の機能追加・修正
- **徹底**: リリース前、重要なリファクタリング

### 2. プロンプトのカスタマイズ

チーム固有のルールを追加：

```
## 当社のコーディング規約
- インデントは2スペース
- コメントは必ず日本語で記述
- 関数は1つの責務のみ
```

### 3. false positiveへの対処

AIが誤検知した場合は、プロンプトに例外を明記：

```
以下は問題ではありません：
- テストコード内のハードコーディングされた値
- 設定ファイル内のサンプルAPIキー（"your-api-key-here"）
```

### 4. 継続的改善

レビュー結果をファイルに保存し、定期的に振り返り：

```bash
# 過去のレビュー結果を分析
/analyze-review-trends
```

## チーム導入のヒント

### ステップ1: 試験運用

まずは個人で試して、精度と有用性を確認

### ステップ2: ルールの調整

チームのコーディング規約に合わせてプロンプトを調整

### ステップ3: 段階的導入

最初は「参考意見」として活用し、信頼性が高まったら必須チェックに

### ステップ4: 人間レビューとの併用

AIレビューで基本的な問題をキャッチし、人間は設計やビジネスロジックに集中

## 効果測定

ワークフロー導入後の変化を測定：

- レビュー時間の短縮
- バグ発見率の向上
- リリース後の問題件数
- チーム内のコード品質スコア

## まとめ

Claude Code Workflow Studioで設計したAIレビューワークフローは、コード品質向上と効率化を同時に実現します。

**覚えておくべきポイント**：
- ✅ セキュリティ、パフォーマンス、品質を網羅
- ✅ レビューレベルで柔軟に対応
- ✅ チーム固有のルールを組み込み可能
- ✅ 人間レビューと併用して最大効果

次は、[よくある質問と回答](/blog/005-faq)で疑問を解消しましょう。
